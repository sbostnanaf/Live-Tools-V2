# üöÄ Guide de D√©ploiement AWS - Trading Dashboard

Ce guide d√©taille le processus complet de d√©ploiement de votre dashboard de trading sur AWS EC2.

## üìã Table des Mati√®res

1. [Pr√©requis AWS](#pr√©requis-aws)
2. [Configuration EC2](#configuration-ec2)
3. [D√©ploiement Automatique](#d√©ploiement-automatique)
4. [Configuration DNS](#configuration-dns)
5. [SSL/TLS Setup](#ssltls-setup)
6. [Monitoring Setup](#monitoring-setup)
7. [S√©curit√©](#s√©curit√©)
8. [D√©pannage](#d√©pannage)

## üéØ Pr√©requis AWS

### Compte AWS
- Compte AWS actif avec permissions EC2
- Elastic IP disponible (recommand√©)
- Acc√®s √† Route 53 si vous utilisez un domaine personnalis√©

### Instance EC2 Recommand√©e

| Composant | Minimum | Recommand√© | Production |
|-----------|---------|------------|-------------|
| Type | t3.small | t3.medium | t3.large |
| vCPUs | 2 | 2 | 2 |
| RAM | 2 GB | 4 GB | 8 GB |
| Stockage | 15 GB | 20 GB | 50 GB |
| R√©seau | Basic | Enhanced | Enhanced |

### AMI Recommand√©es
- **Ubuntu 20.04 LTS** (ami-0c02fb55956c7d316)
- **Ubuntu 22.04 LTS** (ami-08d4ac5b634553e16)
- **Amazon Linux 2** (ami-0abcdef1234567890)

## üñ•Ô∏è Configuration EC2

### 1. Lancement de l'Instance

```bash
# Via AWS CLI
aws ec2 run-instances \
    --image-id ami-0c02fb55956c7d316 \
    --instance-type t3.medium \
    --key-name votre-cle-ssh \
    --security-group-ids sg-xxxxxxxxx \
    --subnet-id subnet-xxxxxxxxx \
    --associate-public-ip-address \
    --block-device-mappings '[{
        "DeviceName": "/dev/sda1",
        "Ebs": {
            "VolumeSize": 20,
            "VolumeType": "gp3",
            "DeleteOnTermination": true
        }
    }]' \
    --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=TradingDashboard}]'
```

### 2. Security Group

Cr√©ez un Security Group avec les r√®gles suivantes :

| Type | Protocol | Port | Source | Description |
|------|----------|------|---------|-------------|
| SSH | TCP | 22 | Votre IP | Acc√®s administrateur |
| HTTP | TCP | 80 | 0.0.0.0/0 | Trafic web |
| HTTPS | TCP | 443 | 0.0.0.0/0 | Trafic web s√©curis√© |
| Custom TCP | TCP | 3001 | Votre IP | Grafana (optionnel) |

```bash
# Cr√©er le Security Group
aws ec2 create-security-group \
    --group-name trading-dashboard-sg \
    --description "Security group for Trading Dashboard"

# Ajouter les r√®gles
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxxx \
    --protocol tcp \
    --port 22 \
    --source-group 0.0.0.0/0

aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxxx \
    --protocol tcp \
    --port 80 \
    --source-group 0.0.0.0/0

aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxxx \
    --protocol tcp \
    --port 443 \
    --source-group 0.0.0.0/0
```

### 3. Elastic IP (Recommand√©)

```bash
# Allouer une Elastic IP
aws ec2 allocate-address --domain vpc

# Associer √† l'instance
aws ec2 associate-address \
    --instance-id i-xxxxxxxxx \
    --allocation-id eipalloc-xxxxxxxxx
```

## üöÄ D√©ploiement Automatique

### 1. Connexion √† l'Instance

```bash
# Connexion SSH
ssh -i votre-cle.pem ubuntu@votre-ip-publique

# Ou utilisez votre configuration SSH existante
ssh SERVEUR_NANAF
```

### 2. Script de D√©ploiement Automatique

```bash
# Cloner le repository
git clone https://github.com/votre-username/trading-dashboard.git
cd trading-dashboard

# Rendre le script ex√©cutable
chmod +x deploy/aws-deploy.sh

# Lancer le d√©ploiement
./deploy/aws-deploy.sh
```

### 3. Processus de D√©ploiement

Le script automatique effectue les √©tapes suivantes :

#### Phase 1 : Pr√©paration du Syst√®me
```bash
[INFO] Checking system requirements...
[INFO] Installing system dependencies...
[SUCCESS] Docker installed
[SUCCESS] Docker Compose installed
```

#### Phase 2 : Configuration S√©curit√©
```bash
[INFO] Configuring firewall...
[SUCCESS] Firewall configured
[INFO] Setting up SSL certificates...
[SUCCESS] Self-signed SSL certificates generated
```

#### Phase 3 : Configuration Application
```bash
[INFO] Setting up environment variables...
[SUCCESS] Generated random database password
[SUCCESS] Generated random Redis password
[SUCCESS] Generated random JWT secret
[SUCCESS] Environment variables configured
```

#### Phase 4 : D√©ploiement
```bash
[INFO] Building and deploying the application...
[SUCCESS] postgres is running
[SUCCESS] redis is running
[SUCCESS] backend is running
[SUCCESS] frontend is running
[SUCCESS] nginx is running
[SUCCESS] Application deployed successfully
```

### 4. Configuration Post-D√©ploiement

Apr√®s le d√©ploiement automatique :

```bash
# V√©rifier l'√©tat des services
docker-compose ps

# V√©rifier les logs
docker-compose logs -f

# Test de connectivit√©
curl -k https://localhost/health
```

## üåê Configuration DNS

### Option 1 : Route 53 (AWS)

```bash
# Cr√©er une Hosted Zone
aws route53 create-hosted-zone \
    --name votre-domaine.com \
    --caller-reference $(date +%s)

# Cr√©er un enregistrement A
aws route53 change-resource-record-sets \
    --hosted-zone-id Z123456789 \
    --change-batch '{
        "Changes": [{
            "Action": "CREATE",
            "ResourceRecordSet": {
                "Name": "dashboard.votre-domaine.com",
                "Type": "A",
                "TTL": 300,
                "ResourceRecords": [{"Value": "VOTRE-IP-PUBLIQUE"}]
            }
        }]
    }'
```

### Option 2 : Registrar Externe

Chez votre registrar de domaine, cr√©ez :
- **Enregistrement A** : `dashboard.votre-domaine.com` ‚Üí `VOTRE-IP-PUBLIQUE`
- **TTL** : 300 secondes (5 minutes)

### V√©rification DNS

```bash
# V√©rifier la propagation DNS
nslookup dashboard.votre-domaine.com
dig dashboard.votre-domaine.com

# Test depuis diff√©rents serveurs DNS
dig @8.8.8.8 dashboard.votre-domaine.com
dig @1.1.1.1 dashboard.votre-domaine.com
```

## üîí SSL/TLS Setup

### Option 1 : Let's Encrypt (Recommand√©)

Le script de d√©ploiement propose automatiquement Let's Encrypt :

```bash
# Pendant le d√©ploiement
Do you want to set up Let's Encrypt SSL certificates? (y/n): y
Enter your domain name: dashboard.votre-domaine.com
Enter your email address: admin@votre-domaine.com

[INFO] Setting up Let's Encrypt for dashboard.votre-domaine.com...
[SUCCESS] Let's Encrypt SSL certificates configured
```

### Option 2 : Configuration Manuelle Let's Encrypt

```bash
# Installer Certbot
sudo apt update
sudo apt install -y certbot python3-certbot-nginx

# Obtenir le certificat
sudo certbot --nginx -d dashboard.votre-domaine.com \
    --email admin@votre-domaine.com \
    --agree-tos \
    --non-interactive

# V√©rifier le renouvellement automatique
sudo certbot renew --dry-run

# Configurer le renouvellement automatique
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### Option 3 : Certificat Personnalis√©

```bash
# Copier vos certificats
sudo cp votre-certificat.crt /opt/trading-dashboard/nginx/ssl/
sudo cp votre-cle-privee.key /opt/trading-dashboard/nginx/ssl/

# Modifier la configuration Nginx
sudo nano /opt/trading-dashboard/nginx/nginx.conf

# Red√©marrer Nginx
docker-compose restart nginx
```

### V√©rification SSL

```bash
# Test SSL
openssl s_client -connect dashboard.votre-domaine.com:443 -servername dashboard.votre-domaine.com

# V√©rification en ligne
curl -I https://dashboard.votre-domaine.com/health

# Test de s√©curit√© SSL
# Utilisez https://www.ssllabs.com/ssltest/
```

## üìä Monitoring Setup

### Grafana Configuration

```bash
# Acc√©der √† Grafana
https://dashboard.votre-domaine.com:3001

# Identifiants par d√©faut
Username: admin
Password: (d√©fini dans .env GRAFANA_PASSWORD)
```

### Dashboards Pr√©d√©finis

1. **System Metrics**
   - CPU, RAM, Disk utilization
   - Network traffic
   - Docker container status

2. **Application Metrics**
   - API response times
   - Database queries
   - Active users
   - Trade volume

3. **Security Metrics**
   - Failed login attempts
   - API rate limiting
   - Error rates

### Prometheus Targets

Le fichier `monitoring/prometheus.yml` configure automatiquement :

```yaml
scrape_configs:
  - job_name: 'trading-dashboard'
    static_configs:
      - targets: ['backend:8000']
  
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
  
  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx:8080']
```

### Alertes Personnalis√©es

```bash
# √âditer les r√®gles d'alerte
nano monitoring/alert-rules.yml

# Exemple d'alerte
groups:
  - name: trading-dashboard-alerts
    rules:
      - alert: HighCPUUsage
        expr: cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% for more than 5 minutes"
```

## üõ°Ô∏è S√©curit√©

### Hardening du Syst√®me

```bash
# Mise √† jour du syst√®me
sudo apt update && sudo apt upgrade -y

# Configuration SSH s√©curis√©e
sudo nano /etc/ssh/sshd_config

# Ajouts recommand√©s :
# PasswordAuthentication no
# PermitRootLogin no
# Protocol 2
# AllowUsers ubuntu

# Red√©marrer SSH
sudo systemctl restart ssh

# Installation fail2ban
sudo apt install -y fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### Configuration UFW Avanc√©e

```bash
# R√®gles sp√©cifiques par IP (optionnel)
sudo ufw allow from VOTRE_IP_BUREAU to any port 3001  # Grafana
sudo ufw allow from VOTRE_IP_BUREAU to any port 9090  # Prometheus

# Limitation de d√©bit SSH
sudo ufw limit ssh

# Log UFW
sudo ufw logging on

# V√©rifier les r√®gles
sudo ufw status verbose
```

### Monitoring S√©curit√©

```bash
# Logs de s√©curit√©
sudo tail -f /var/log/auth.log
sudo tail -f /var/log/ufw.log

# Surveillance des connexions
sudo netstat -tulnp | grep :443
sudo ss -tulnp | grep :443

# V√©rification des processus Docker
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

## üîß Optimisation Performance

### Configuration Docker

```bash
# Optimisation Docker daemon
sudo nano /etc/docker/daemon.json

{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "default-ulimits": {
    "nofile": {
      "name": "nofile",
      "hard": 64000,
      "soft": 64000
    }
  }
}

# Red√©marrer Docker
sudo systemctl restart docker
```

### Optimisation Nginx

```bash
# Ajustements de performance dans nginx.conf
worker_processes auto;
worker_connections 2048;
client_max_body_size 16M;

# Cache statique
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
}
```

### Optimisation PostgreSQL

```bash
# Configuration PostgreSQL
docker-compose exec postgres bash -c "echo '
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 4MB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
' >> /var/lib/postgresql/data/postgresql.conf"

# Red√©marrer PostgreSQL
docker-compose restart postgres
```

## üîç D√©pannage

### Probl√®mes de D√©ploiement

#### Erreur : Port d√©j√† utilis√©
```bash
# Identifier le processus utilisant le port
sudo netstat -tulpn | grep :80
sudo netstat -tulpn | grep :443

# Arr√™ter le processus conflictuel
sudo systemctl stop apache2  # Si Apache est install√©
sudo systemctl stop nginx    # Si Nginx syst√®me est install√©

# Red√©ployer
docker-compose up -d
```

#### Erreur : Espace disque insuffisant
```bash
# V√©rifier l'espace disque
df -h

# Nettoyer Docker
docker system prune -a
docker volume prune

# Nettoyer les logs syst√®me
sudo journalctl --vacuum-time=7d
```

#### Erreur : M√©moire insuffisante
```bash
# V√©rifier l'utilisation m√©moire
free -h
docker stats

# Ajouter du swap
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### Probl√®mes SSL

#### Certificat Let's Encrypt √©choue
```bash
# V√©rifier la configuration DNS
nslookup votre-domaine.com

# V√©rifier l'accessibilit√© du serveur
curl -I http://votre-domaine.com/.well-known/acme-challenge/

# Renouveler manuellement
sudo certbot renew --force-renewal -d votre-domaine.com
```

#### Erreur de certificat auto-sign√©
```bash
# R√©g√©n√©rer les certificats
rm -f nginx/ssl/*
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout nginx/ssl/trading-dashboard.key \
    -out nginx/ssl/trading-dashboard.crt \
    -subj "/C=FR/ST=State/L=City/O=TradingDashboard/CN=votre-domaine.com"

# Red√©marrer Nginx
docker-compose restart nginx
```

### Probl√®mes de Performance

#### Application lente
```bash
# V√©rifier les m√©triques syst√®me
htop
docker stats

# Analyser les logs Nginx
docker-compose logs nginx | grep "request_time"

# V√©rifier la base de donn√©es
docker-compose exec postgres pg_stat_activity

# Optimiser les requ√™tes lentes
docker-compose exec postgres psql -U trading_user -d trading_db \
    -c "SELECT query, mean_time, calls FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"
```

### Support et Logs

#### Collecte d'Informations de Debug
```bash
# Script de diagnostic complet
cat > debug-info.sh << 'EOF'
#!/bin/bash
echo "=== System Information ==="
uname -a
df -h
free -h
docker --version
docker-compose --version

echo -e "\n=== Docker Status ==="
docker-compose ps

echo -e "\n=== Service Logs (last 50 lines) ==="
docker-compose logs --tail=50

echo -e "\n=== Network Configuration ==="
ip addr show
ss -tulnp | grep -E ':(80|443|8000|3000|5432|6379)'

echo -e "\n=== Nginx Configuration Test ==="
docker-compose exec nginx nginx -t 2>&1 || echo "Nginx config test failed"

echo -e "\n=== SSL Certificate Info ==="
openssl x509 -in nginx/ssl/trading-dashboard.crt -text -noout | grep -E "(Subject|Not After)" 2>/dev/null || echo "SSL certificate not found"
EOF

chmod +x debug-info.sh
./debug-info.sh > diagnostic-report.txt
```

## üìû Support

Pour obtenir de l'aide :

1. **Logs d√©taill√©s** : `docker-compose logs -f`
2. **√âtat des services** : `docker-compose ps`
3. **M√©triques syst√®me** : Grafana dashboard
4. **Documentation** : Consultez les fichiers de docs/
5. **Issues** : Cr√©ez une issue avec le rapport de diagnostic

---

**D√©ploiement r√©ussi ?** üéâ Votre dashboard est maintenant accessible √† `https://votre-domaine.com` !